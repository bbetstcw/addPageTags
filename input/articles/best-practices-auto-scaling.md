<properties
   pageTitle="自动缩放指南 | Windows Azure"
   description="有关如何自动缩放以动态分配应用程序所需的资源的指南。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.date="04/28/2015"
   wacn.date="08/29/2015"/>

# 自动缩放指南

![](./media/best-practices-auto-scaling/pnp-logo.png)

## 概述
自动缩放是动态分配应用程序所需的资源，以符合性能要求，满足服务级别协议 (SLA)，同时将运行时成本降到最低的过程。当工作量增大时，应用程序可能需要额外的资源才能及时执行其任务。当需求降低时，可以取消分配资源，使成本降到最低，同时保持适当的性能并符合 SLA。自动缩放可以利用云托管环境的弹性，同时可以通过减少操作员持续监视系统性能的需要来降低管理开销，并做出有关添加或删除资源的决策。
> 自动缩放将应用到应用程序使用的所有资源，而不只是计算资源。例如，如果系统使用消息队列来发送和接收信息，则可以在缩放时创建更多队列。

## 缩放类型
缩放通常有两种 — 垂直缩放和水平缩放：

- **垂直缩放**（通常称为_向上和向下缩放_）需要修改硬件（扩展或缩小硬件的容量和性能），或使用具有适当容量和性能的替代硬件来重新部署解决方案。在云环境中，硬件平台通常是虚拟环境。除非原始硬件已大幅超出设置，否则随着因应性前期资本支出，这种环境中的垂直向上缩放将涉及到设置功能更强大的资源，然后将系统转移到这些新资源。垂直缩放通常是破坏性的过程，会在重新部署时使系统暂时不可用。在设置新硬件并将其联机时，也许可以将原始系统保持运行，但在将旧环境的处理转换到新系统时，仍有可能会导致某种形式的中断。使用自动缩放来实施垂直缩放策略并不常见。
- **水平缩放**（通常称为_向外和向内缩放_）需要在更多或更少的资源上部署解决方案，这些资源通常是商用资源，而不是高能系统。在设置这些资源时，解决方案可以继续运行而不中断。设置过程完成后，可将构成方案的元素副本部署到这些附加的资源上并提供使用。如果需求降低，则在使用附加资源的元素完全关闭后，可以回收这些资源。许多基于云的系统（包括 Microsoft Azure）支持这种缩放形式的自动化。

## 实施自动缩放策略
实施自动缩放策略通常涉及到以下组件和过程：

- 位于应用程序、服务和基础结构级别的检测和监视系统，用于捕获响应时间、队列长度、CPU 利用率和内存使用量等关键度量值。
- 决策逻辑，可以根据预定义的系统阈值或计划来评估受监视的缩放系数，并做出有关是否要缩放的决策。
- 负责执行与缩放系统（例如设置或取消设置资源）相关任务的组件。
- 测试、监视和优化自动缩放策略，以确保它按预期工作。

大多数基于云的环境（例如 Microsoft Azure）提供用于处理常见方案的内置自动缩放机制。如果使用的环境或服务不提供所需的自动缩放功能，或者有超出其功能范围的极端自动缩放要求，则可能需要使用自定义实施来收集操作和系统度量值、分析这些度量值以识别相关数据，然后相应地缩放资源。

## 实施自动缩放的注意事项
自动缩放不是即时见效的解决方案。只是将资源添加到系统或运行进程的更多实例并不能保证提高系统性能。设计自动缩放策略时，请注意以下几点：

- 系统必须设计为可以水平缩放。不要在实例相关性方面做出假设；不要设计需要代码始终在特定的进程实例中运行的解决方案。水平缩放云服务或网站时，不要假设一系列来自同一源的请求始终路由到同一实例。出于相同原因，请将服务设计为无状态，以避免需要将一系列来自应用程序的请求始终路由到同一服务实例。在设计从队列读取并处理消息的服务时，不要假设哪个服务实例处理哪个特定消息，因为自动缩放可能会在队列长度增大时启动其他服务实例。[使用者竞争模式](http://msdn.microsoft.com/zh-cn/library/dn568101.aspx)说明了如何解决这种情况。
- 如果解决方案实施长时间运行的任务，请将此任务设计为同时支持向外和向内缩放。如果不保持应有的谨慎，这种任务在系统向内缩放时会阻止进程实例完全关闭；如果进程被强行终止，则可能会丢失数据。理想的情况是，重构长时间运行的任务并分解处理，使其以较小且不连续的块执行。[管道和筛选器模式](http://msdn.microsoft.com/zh-cn/library/dn568100.aspx)提供了有关如何实现此目的的示例。或者，你可以实施检查点机制，用于定期记录任务的状态信息，并将此状态保存在运行任务的任何进程实例可以访问的持久性存储中。这样，如果进程关闭，它所执行的工作可以使用另一个实例，从最后一个检查点继续进行。
- 当后台任务在独立的计算实例（例如云服务托管应用程序的辅助角色）上运行时，可能需要使用不同的缩放策略来缩放应用程序的不同部分。例如，你可能需要部署其他 UI 计算实例而不增加后台计算实例数，或是相反。如果你提供不同级别的服务（例如基本和高级服务包），可能需要使用比基本服务包更主动的高级服务包的计算资源才能符合 SLA。
- 考虑使用 UI 和后台计算实例通信的队列长度作为自动缩放策略的驱动因素。这可以最好地反映当前负载与后台任务处理容量之间的不平衡或差异。
- 如果自动缩放策略基于度量业务进程（例如每小时订单数或复杂事务的平均执行时间）的计数器，请确保完全了解这些计数器类型的结果与实际计算容量要求之间的关系。可能需要缩放多个组件或计算单位来应对业务进程计数器的变化。  
- 若要防止系统过度地向外缩放并避免由于运行数千个实例而产生的关联成本，请考虑限制可以自动添加的实例数上限。大多数自动缩放机制允许你指定规则的实例数上限和下限。此外，如果部署的实例数已达到上限而系统仍然过载，请考虑适当地降低系统提供的功能。
- 请记住，自动缩放可能不是处理工作负荷中突发高峰的最适当机制。设置并启动新服务实例或将资源添加到系统都需要花费时间，而当这些附加资源可供使用时，高峰期可能已过。在这种情况下，限制服务可能更适合。有关详细信息，请参阅[限制模式](http://msdn.microsoft.com/zh-cn/library/dn589798.aspx)。
- 相反地，如果你希望在事务量快速波动时有足够的容量处理所有请求，并且成本不是主要考虑因素，那么，请考虑使用激进的自动缩放策略来更快速地启动附加实例，或使用计划的策略在最大负载来临前预先启动足量的实例。
- 自动缩放机制应该监视自动缩放过程，并记录每个自动缩放事件的详细信息（触发的事件、添加或删除了哪些资源，以及时间）。在创建自定义自动缩放机制时，请确保它包含此功能。可以分析信息以帮助度量自动缩放策略的有效性，并根据需要进行优化 — 包括在短时间内使用模式变得明显，以及长期业务拓展或对应用程序的要求变化时。如果应用程序达到定义的自动缩放上限，机制可以提醒操作人员，让操作人员手动启动其他资源（如果局势允许这样做）。请注意，在这种情况下，操作人员可能还要负责在工作负荷减轻后手动删除这些资源。

## Azure 解决方案中的自动缩放
可以使用多个选项为 Azure 解决方案配置自动缩放：

- **Azure 自动缩放**。此功能支持基于计划的最常见缩放方案，并可以选择性地支持基于运行时度量值（例如处理器利用率、队列长度，或内置和自定义的计数器）触发的缩放操作。你可以使用 Azure 管理门户快速轻松地配置解决方案的简单自动缩放策略，还可以使用 Azure 监视服务管理库，以更精细的控制度配置自动缩放规则。有关详细信息，请参阅 [Azure 监视服务管理库](#the-azure-monitoring-services-management-library)部分。
- 基于诊断、监视和 Azure 服务管理功能的**自定义解决方案**。例如，你可以使用 Azure 诊断、自定义代码或[System Center Management Pack for Azure](http://www.microsoft.com/download/details.aspx?id=38414) 来持续监视应用程序的性能，并使用 [Azure 服务管理 REST API](http://msdn.microsoft.com/zh-cn/library/azure/ee460799.aspx)、[Microsoft Azure 管理库](https://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Libraries)或[自动缩放应用程序块](http://msdn.microsoft.com/zh-cn/library/hh680892%28v=pandp.50%29.aspx)来向外和向内缩放。用于触发缩放操作的度量值可以是任何内置或自定义的计数器，或者是在应用程序中实施的其他检测。但是，自定义解决方案并不容易实施，只应在前述方法都无法满足要求时才加以考虑。请注意，自动缩放应用程序块是一个开放源代码框架，不受 Microsoft 的直接支持。
- **第三方服务**（例如 [Paraleap AzureWatch](http://www.paraleap.com/AzureWatch)）可让你使根据计划、服务负载和系统性能指标、自定义规则以及不同规则类型的组合来缩放解决方案。

选择要采用哪种自动缩放解决方案时，请注意以下几点：

- 如果平台的内置自动缩放功能可以符合要求，就使用此内置功能。否则，请仔细考虑是否真正需要更复杂的缩放功能。内置自动缩放功能无法满足的其他要求的示例包括更高粒度的控制、检测缩放触发事件的其他方式、跨订阅缩放、缩放其他资源类型，等等。
- 考虑是否可以足够精确地预测应用程序负载，以便只依赖于计划的自动缩放（添加和删除实例以满足需求的预期高峰）。如果不可行，则根据在运行时收集的度量值使用被动自动缩放，使应用程序能够处理无法预测的需求变化。但是，结合使用这些方法较为合适。例如，如果你知道应用程序何时最繁忙，则可以创建一个策略，以根据计划添加计算、存储和队列等资源。这有助于确保容量在需要时可供使用，并且不会在启动新实例时遇到延迟。此外，对于每个计划的规则，请定义在该期间允许被动自动缩放的度量值，以确保应用程序能够处理持续但无法预测的需求高峰。
- 通常很难了解度量值与容量要求之间的关系，尤其是在最初部署应用程序后。建议在一开始多设置一些附加容量，然后监视并调整自动缩放规则，使容量更接近实际负载的需要。

### 使用 Azure 自动缩放
Azure 自动缩放可让你配置解决方案的向外缩放和向内缩放选项。Azure 自动缩放可以自动添加和删除 Azure 云服务 Web 角色和辅助角色、Azure 移动服务以及 Azure 网站应用程序的实例。它还可以通过启动和停止 Azure 虚拟机的实例来启用自动缩放。Azure 自动缩放策略包括两组因素：

- 基于计划的自动缩放，可确保提供附加实例来满足预期高峰使用量，并可在高峰时间过后向内缩放。这可以让你确保拥有足够的运行中实例，而无需等待系统向负载做出反应。
- 基于度量值的自动缩放，对最后一个小时的平均 CPU 利用率或 Azure 存储空间或服务总线队列中解决方案正在处理的消息待处理项等因素做出反应。这样，应用程序便可以独立于计划的自动缩放规则，适应计划外或无法预见的需求变化。

使用 Azure 自动缩放时，请注意以下几点：

- 自动缩放策略结合了计划的缩放和基于度量值的缩放。你可以为服务指定两种规则，使应用程序同时根据计划和负载变化响应做出缩放。
- 你应该配置 Azure 自动缩放规则，然后监视应用程序在一段时间内的性能。如果需要，请使用这种监视的结果来调整系统的缩放方式。但请记住，自动缩放不是即时起效的过程 — 它需要时间来对度量值（例如平均 CPU 利用率超过或低于指定的阈值）做出反应。
- 使用基于测得触发器属性（例如 CPU 使用量或队列长度）的检测机制的自动缩放规则使用一段时间内的聚合值而不是即时值来触发自动缩放操作。默认情况下，聚合是值的平均值。这可以防止系统反应太快，或导致快速震荡。这还可以使自动启动的新实例顺利进入运行模式，避免当新实例正在启动时，又发生其他自动缩放操作。对于云服务和虚拟机，聚合的默认期限为 45 分钟，度量值需要经过这段时间后才为了响应需求高峰而触发自动缩放。可以使用 SDK 更改聚合期限，但请注意，低于 25 分钟可能导致不可预测的结果（有关详细信息，请参阅[使用 Azure 监视服务管理库根据 CPU 百分比自动缩放云服务](http://rickrainey.com/2013/12/15/auto-scaling-cloud-services-on-cpu-percentage-with-the-windows-azure-monitoring-services-management-library/)）。对于 Azure 网站，平均期限要短得多，这样便可以在平均触发测量值更改约五分钟后提供新实例。
- 如果使用 SDK 而不是 Web 门户配置自动缩放，则可以指定更详细的计划，在执行该计划期间，规则将处于活动状态。你还可以创建自己的度量值，并将其与自动缩放规则中的现有度量值一起使用，或单独使用。例如，你可能希望使用替代计数器（例如每秒请求数或平均内存可用性）或使用自定义计数器来计算特定的业务进程。有关详细信息，请参阅 [Azure 监视服务管理库](#the-azure-monitoring-services-management-library)部分。
- 自动缩放 Azure 虚拟机时，必须部署相当于允许自动缩放启动的最大数的虚拟机实例数。这些实例必须属于同一个可用性集。虚拟机自动缩放机制不会创建或删除虚拟机的实例；而你配置的自动缩放规则将启动和停止相应数目的实例。有关详细信息，请参阅[自动缩放运行 Web 角色、辅助角色或虚拟机的应用程序](/documentation/articles/cloud-services-how-to-scale#autoscale)。
- 如果无法启动新的实例，则原因可能是已达到订阅的最大值（例如，使用虚拟机服务时的核心数上限），或者在启动期间发生错误，而门户可能显示自动缩放操作成功。但是，门户中显示的后续 **ChangeDeploymentConfiguration** 事件只显示已请求服务启动，而不会有任何事件指示是否已成功完成。
- 在 Azure 自动缩放中，可以使用 Web 门户 UI 将 SQL 数据库实例和队列等资源链接到计算服务实例。这样，你便可以更轻松地访问每个链接资源的各个手动和自动缩放配置选项。有关详细信息，请参阅“如何管理云服务”页中的[如何：将资源链接到云服务](/documentation/articles/cloud-services-how-to-manage#linkresources)，以及[如何缩放应用程序](/documentation/articles/cloud-services-how-to-scale)页。
- 当你配置多个策略和规则时，它们有可能相互冲突。Azure 自动缩放使用以下冲突解决规则来确保始终有足量的运行中实例：
  - 向外缩放操作始终优先于向内缩放操作。
  - 当向外缩放操作发生冲突时，使实例数增幅最大的规则优先。
  - 当向内缩放操作发生冲突时，使实例数降幅最小的规则优先。

<a name="the-azure-monitoring-services-management-library"></a>

### Azure 监视服务管理库
你可以使用服务管理 API 以更精细的控制度来配置 Azure 自动缩放，以及访问无法通过 Web 门户获得的功能。此 API 可以 REST Web API 的形式直接访问，或通过 Azure 监视服务管理库进行访问。

可以通过指定云服务角色、虚拟机可用性集、Azure 网站（作为 Web 空间中的服务器场），或 Azure 移动服务的自动缩放配置文件来配置 Azure 自动缩放。每个配置文件的目标可以多达 20 个，分别指示：

- 应用时机（使用循环或固定日期间隔），
- 允许的实例数（最小值、最大值和默认数目）
- 生效的自动缩放规则

使用 Web 门户可以配置一组固定的配置文件，主要用于区分日间/夜间以及工作日/周末配置文件，配合一对基于 CPU 利用率或队列长度的缩放规则。如果改用服务管理 API，你可以为配置文件配置更精细的适用日期，并最多指定 10 个规则，其中包含基于 Azure 监视服务可用的任何度量值的触发器。

自动缩放规则包含一个用于指示何时应用规则的触发器，以及指示要对目标配置执行的更改的缩放操作。在编写本文时，唯一支持的操作是增加或减少实例计数。

自动缩放规则的触发器基于可用度量值。将会根据自动缩放配置中的定义，从相应的源定期采样所配置度量值的值。评估每个活动配置文件的规则时，触发器上指定的度量值将及时跨实例聚合（如果适用），此聚合值将与阈值进行比较，以指示是否要应用规则。将计算基于时间的有效聚合值的平均值（默认值）、最小值、最大值、最终值、合计值和计数。将计算基于实例的有效聚合值的平均值（默认值）、最小值和最大值。

触发器可用的度量值为 Azure 存储空间和服务总线队列长度、Azure 诊断发布的标准性能计数器以及每个角色或虚拟机发布的任何自定义性能计数器。在云服务解决方案中，针对服务处理非默认提供的性能计数器时，必须将 UI 中的监视级别设置从“最小”更改为“详细”。

有关详细信息，请参阅：

- 监视 SDK [类库](http://msdn.microsoft.com/zh-cn/library/azure/dn510414.aspx)
- [如何配置性能计数器](http://msdn.microsoft.com/zh-cn/library/azure/dn535595.aspx)
- [自动缩放的相关操作](http://msdn.microsoft.com/zh-cn/library/azure/dn510374.aspx)
- [添加自动缩放设置](http://msdn.microsoft.com/zh-cn/library/azure/dn510372.aspx)
- [使用 Azure 监视服务管理库根据 CPU 百分比自动缩放云服务](http://rickrainey.com/2013/12/15/auto-scaling-cloud-services-on-cpu-percentage-with-the-windows-azure-monitoring-services-management-library/)
- [如何使用 Azure 监视服务管理库创建自动缩放规则](http://blogs.msdn.com/b/cie/archive/2014/02/20/how-to-use-windows-azure-monitoring-services-management-library-to-create-an-autoscale-rule.aspx)

## 相关模式和指南
实施自动缩放时，以下模式和指南也可能与你的方案相关：

- [限制模式](http://msdn.microsoft.com/zh-cn/library/dn589798.aspx)。此模式描述当需求增大而对资源产生极大负载时，应用程序如何继续工作并满足服务级别协议。限制可与自动缩放配合使用，以避免系统向外缩放时失控。
- [使用者竞争模式](http://msdn.microsoft.com/zh-cn/library/dn568101.aspx)。此模式描述如何实施服务实例池，以便处理来自任何应用程序实例的消息。自动缩放可用于启动和停止服务实例，以符合预期的工作负荷。此模式可让系统同时处理多个消息，以优化吞吐量、提高可缩放性和可用性，以及平衡工作负荷。
- [检测和遥测指南](http://msdn.microsoft.com/zh-cn/library/dn589775.aspx)。检测和遥测在收集信息以促成自动缩放过程方面至关重要。

## 详细信息
- [如何缩放应用程序](/documentation/articles/cloud-services-how-to-scale)
- [自动缩放运行 Web 角色、辅助角色或虚拟机的应用程序](/documentation/articles/cloud-services-how-to-manage#linkresources)
- [如何：将资源链接到云服务](/documentation/articles/cloud-services-how-to-manage#linkresources)
- [缩放链接的资源](/documentation/articles/cloud-services-how-to-scale#scalelink)
- [Azure 监视服务管理库](http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Monitoring)
- [Azure 服务管理 REST API](http://msdn.microsoft.com/zh-cn/library/azure/ee460799.aspx)
- [自动缩放的相关操作](http://msdn.microsoft.com/zh-cn/library/azure/dn510374.aspx)
- [Microsoft.WindowsAzure.Management.Monitoring.Autoscale 命名空间](http://msdn.microsoft.com/zh-cn/library/azure/microsoft.windowsazure.management.monitoring.autoscale.aspx)
- MSDN 上的[自动缩放应用程序块](http://msdn.microsoft.com/zh-cn/library/hh680892%28v=pandp.50%29.aspx)文档和重要方案。

<!---HONumber=67-->