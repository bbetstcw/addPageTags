<properties 
   pageTitle="Azure SQL 数据库资源限制"
   description="本页介绍 Azure SQL 数据库的一些常见资源限制。"
   services="sql-database"
   documentationCenter="na"
   authors="rothja"
   manager="jeffreyg"
   editor="monicar" />
<tags 
   ms.service="sql-database" ms.date="07/13/2015" wacn.date="08/14/2015" />

# Azure SQL 数据库资源限制

Azure SQL 数据库会对共享资源（例如事务日志、I/O 和其他许多资源）的使用进行监视。这样 Azure SQL Databse 便可将数据库限定在既定的资源边界之内。此资源边界或阈值称为资源限制。当客户端使用的资源超过这些限制时，Azure SQL 数据库将在租户或在物理节点级别，通过管理资源使用率来进行响应，而这会导致连接断开或请求被拒绝。

> [AZURE.NOTE]当资源限制妨碍了查询分析数据库性能问题时，你可能需要使用专用的管理员连接 (DAC)（从 Azure SQL 数据库V12 开始提供的功能）。有关使用 DAC 的详细信息，请参阅[为数据库管理员提供的诊断连接](https://msdn.microsoft.com/zh-cn/library/ms189595.aspx)。

## 资源限制摘要表

下表汇总了每种资源的限制，当超过这些限制时，Azure SQL 数据库会拒绝对受影响资源的请求或终止与受影响资源的连接，然后返回一个错误代码。在某些情况下，服务层（基本、标准、高级）和性能级别决定了确切的限制。对于这些情况，请参阅 [Azure SQL 数据库服务层和性能级别](https://msdn.microsoft.com/zh-cn/library/azure/dn741336.aspx)。

[AZURE.INCLUDE [azure-sql-database-limits](../includes/azure-sql-database-limits.md)]

## 了解错误代码

有时，会为一种资源的多个限制条件返回相同的错误代码。这些条件在错误消息中标识为“状态”。例如，对于“事务日志长度”资源，会显示以下两条错误消息。尽管错误的文本相同，但根据限制条件的不同，它们具有不同的“状态”值（分别为 1 和 2）。

错误消息 1：

	Msg 40552, Level 17, State 1, Line 1
	The session has been terminated because of excessive transaction log space usage.
	Try modifying fewer rows in a single transaction.

错误消息 2：

	Msg 40552, Level 17, State 2, Line 1
	The session has been terminated because of excessive transaction log space usage.
	Try modifying fewer rows in a single transaction.

同样的情况适用于在某些消息中出现的资源 ID。资源 ID 可转换成遇到限制的系统资源。

此主题的余下部分将详细说明可能的错误代码，包括在哪些情况下，“状态”值和资源 ID 会提供有关错误的其他信息。

## 数据库大小

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | 当分配给用户数据库的数据库空间已满时，用户会收到数据库已满的错误。 |
| **错误代码** | **40544**: 数据库已达到其大小配额。请将数据分区或删除、删除索引或查阅文档以找到可能的解决方案。 |
| **限制** | 取决于[服务层和性能级别](https://msdn.microsoft.com/zh-cn/library/azure/dn741336.aspx)。 |
| **被拒请求的类型** | Non-Select DML（插入或更新信息的 Insert、Update、Merge）。 |
| **建议** | 使用 DELETE/DROP 语句从数据库中删除数据，直到数据库大小在限制之内为止。 |

## 登录

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | SQL 数据库会调控可与数据库建立的并发登录数限制。达到数据库的并发登录限制后，将拒绝对数据库的新登录请求，并返回错误代码 10928。 |
| **错误代码** | **10928**: 资源 ID: 3。数据库的 %s 限制是 %d 且已达到该限制。如需协助，请参阅 https://msdn.microsoft.com/zh-cn/library/dn338081.aspx。 |
| **限制** | 取决于[服务层和性能级别](https://msdn.microsoft.com/zh-cn/library/azure/dn741336.aspx)。 |
| **建议** | 检查 dm_exec_connections，查看哪些用户连接当前处于活动状态。<br><br>后退并在 10 秒后重试登录。 |

> [AZURE.NOTE]此错误消息中的“资源 ID”值指示已达到限制的资源。对于登录，资源 ID = 3。

## 内存用量

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | 如果有会话等待内存授予超过 20 秒或更长时间，则将按照持有资源时间长度的降序来终止耗用超过 16 MB 内存授予超过 20 秒的会话，从而使最早的会话最先终止。会话终止会在所需内存可用时立即停止。 |
| **错误代码** | **40553**: 由于过度使用内存，已终止该会话。请尝试修改你的查询以处理更少的行。 |
| **限制** | 使用超过 16 MB 内存授予超过 20 秒。 |
| **被拒请求的类型** | 使用内存授予的查询，包括使用排序和哈希联接的查询。 |
| **建议** | 对需要排序和/或哈希联接的查询执行查询优化。 |

## 会话

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | SQL 数据库会调控与数据库建立的并发会话数目限制。当达到数据库的并发会话数限制时，新的数据库连接将被拒绝，且用户将收到错误代码 10928。但是，现有的数据库会话不会终止。 |
| **错误代码** | **10928**: 资源 ID: 2。数据库的 %s 限制是 %d 且已达到该限制。如需协助，请参阅 https://msdn.microsoft.com/zh-cn/library/dn338081.aspx。 |
| **限制** | 取决于[服务层和性能级别](https://msdn.microsoft.com/library/zh-cn/azure/dn741336.aspx)。 |
| **建议** | 检查 dm_exec_requests，查看当前正在执行哪些用户请求。 |

> [AZURE.NOTE]此错误消息中的“资源 ID”值指示已达到限制的资源。对于会话，资源 ID = 2。

## Tempdb

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | 你对 tempdb 的请求可能由于以下三种情况中的任意一种而遭到拒绝：<br><br>**状态 1：**如果会话使用超过 5 GB 的 tempdb 空间，则终止会话。<br><br>**状态 2：**如果 tempdb 中事务的日志大小超过 2 GB，则截断事务。可能占用 tempdb 中日志空间的操作示例：插入、更新、删除、合并和创建索引。<br><br>**状态 3：**tempdb 中未提交的事务可能会阻止日志文件的截断.为防止这种情况发生，tempdb 中从最旧的活动事务日志序列号 (LSN) 到日志末尾（当前 LSN）的距离，不能超过日志文件大小的 20%。如果违反这一规定，tempdb 中违反这一规定的事务将被终止并回滚，以便可以截断日志。 |
| **错误代码** | **40551**: 会话已由于过多的 tempdb 使用而终止。请尝试修改你的查询以减少使用临时表空间。 |
| **限制** | **状态 1：**5 GB tempdb 空间 <br><br>**状态 2：**tempdb 中每个事务 2 GB 空间 <br><br>**状态 3：**tempdb 中总日志空间的 20% |
| **被拒请求的类型** | tempdb 上的任何 DDL 或 DML 语句。 |
| **建议** | 修改查询以降低临时表空间用量，在不再需要临时对象后将它们删除，截断表或删除未使用的表。减少 tempdb 中事务的数据大小，可减少行数或将操作分拆为多个事务。 |

## 事务持续时间

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | 事务会请求对事务依赖的资源（如行、页或表）进行锁定，而当交易不再依赖锁定的资源时，便会释放锁定。你的请求可能由于以下两种情况中的任意一种而遭到拒绝：状态 1：如果事务运行时间超过 24 小时，则将它终止。状态 2：如果事务锁定基础系统任务所需的资源超过 20 秒，则将它终止。 |
| **错误代码** | **40549**: 由于你有长时间运行的事务，已终止会话。请尝试缩短事务运行时间。 |
| **限制** | **状态 1：**24 小时<br><br>**状态 2：**20 秒，如果事务锁定基础系统任务所需的资源 |
| **被拒请求的类型** | 任何运行超过 24 小时的事务或任何采用锁的 DDL 或 DML 语句（导致阻止系统任务）。 |
| **建议** | 对 SQL 数据库执行的操作不应阻止用户输入或有会产生长期运行事务的其他依赖项。 |

## 事务锁计数

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | 使用的锁数超过 100 万的会话将被终止。 |
| **错误代码** | **40550**：由于会话获取的锁过多，已终止该会话。请尝试在单个事务中读取或修改更少的行。 |
| **限制** | 每个事务 100 万个锁 |
| **被拒请求的类型** | 任何 DDL 或 DML 语句。 |
| **建议** | 以下 DMV 可用于监视事务：**sys.dm_tran_active_transactions**、**sys.dm_tran_database_transactions**、**sys.dm_tran_locks** 和 **sys.dm_tran_session_transactions**。根据应用程序的类型，有可能使用较粗粒度的锁提示，如 **PAGLOCK** 或 **TABLOCK**，来减少给定语句/事务中采用的锁数。请注意，这可能对应用程序并发性能产生负面影响。 |

## 事务日志长度

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | 你的请求可能由于以下两种情况中的任意一种而遭到拒绝：<br><br>**状态 1：**SQL 数据库支持最多生成 2 GB 日志的事务。日志大小超过此限制的事务会被截断。可能占用此卷中日志空间的操作示例：插入、更新、删除、合并和创建索引。<br><br>**状态 2：**未提交的事务可能会阻止日志文件的截断。为防止这种情况发生，从最旧的活动事务日志序列号 (LSN) 到日志末尾（当前 LSN）的距离，不能超过日志文件大小的 20%。如果违反这一规定，违反这一规定的事务将被截断并回滚，以便可以截断日志。 |
| **错误代码** | **40552**: 由于过度使用事务日志空间，已终止该会话。请尝试在单个事务中修改更少的行。 |
| **限制** | **状态 1：**每个事务 2 GB<br><br>**状态 2：**总日志空间的 20% |
| **被拒请求的类型** | 任何 DDL 或 DML 语句。 |
| **建议** | 对于行操作，减少事务中数据的大小，例如，减少行数或将操作分拆为多个事务。对于需要单个事务的表/索引操作，请确保遵循以下公式：表中受影响的行数 * （所更新字段的平均字节大小 + 80） < 2 GB（在重建索引时，所更新字段的平均大小应当替换为平均索引大小）。 |

## 工作线程数（最大并发请求数）

| &nbsp; | 更多信息 |
| :--- | :--- |
| **条件** | SQL 数据库会调控对数据库实施的工作线程（并发请求）数限制。并发请求数超过限制的任何数据库都将收到错误 10928，对此数据库的进一步请求可能会遭到拒绝。 |
| **错误代码** | **10928**: 资源 ID: 1。数据库的 %s 限制是 %d 且已达到该限制。如需协助，请参阅 https://msdn.microsoft.com/zh-cn/library/dn338081.aspx。<br><br>**10929**: 资源 ID: 1。%s 最小保证为 %d，最大限制为 %d，数据库的当前使用率为 %d。但是，服务器当前太忙，无法支持针对该数据库的数目大于 %d 的请求。如需协助，请参阅 https://msdn.microsoft.com/zh-cn/library/dn338081.aspx。否则，请稍后再试。 |
| **限制** | 对于高级、基本和标准服务层，将取决于[性能级别](https://msdn.microsoft.com/zh-cn/library/azure/dn741336.aspx)。对于早期的 Web/企业版数据库，最大并发请求限制为 180 并可能会更少，具体取决于系统活动。 |
| **建议** | 检查 dm_exec_requests，查看当前正在执行哪些用户请求。<br><br>后退并在 10 秒后重试请求。 |

> [AZURE.NOTE]此错误消息中的“资源 ID”值指示已达到限制的资源。对于工作线程，资源 ID = 1。

由于调控工作线程而发生的错误 (10928/10929) 会替换工作线程原始的引擎限制错误 (40501)。在正常情况下，用户应不再收到工作线程的引擎限制错误。

在特定情景中，如使用联合数据库功能时，则有可能在登录数据库时引发工作线程限制错误 (10928)，这是因为此操作会在 Connection.Open 调用下利用工作线程。这可能会使应用程序超过工作线程限制阈值。应用程序应有内置逻辑来相应地处理此错误，从而应对这种情况。

## 另请参阅

[Azure SQL 数据库资源管理](https://msdn.microsoft.com/zh-cn/library/azure/dn338083.aspx)

[错误消息 (Azure SQL Database)](https://msdn.microsoft.com/zh-cn/library/azure/ff394106.aspx)

[防止拒绝请求或终止连接的 Azure SQL 数据库最佳实践](https://msdn.microsoft.com/zh-cn/library/azure/dn338082.aspx)

<!---HONumber=66-->